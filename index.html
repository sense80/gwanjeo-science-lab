<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŒ€ì „ê´€ì €ê³ ë“±í•™êµ ê³¼í•™ì‹¤ ì˜ˆì•½ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'chemistry': {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        },
                        'physics': {
                            50: '#faf5ff',
                            100: '#f3e8ff',
                            200: '#e9d5ff',
                            300: '#d8b4fe',
                            400: '#c084fc',
                            500: '#a855f7',
                            600: '#9333ea',
                            700: '#7c3aed',
                            800: '#6b21a8',
                            900: '#581c87',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- í—¤ë” -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">ğŸ§ªâš¡ ê³¼í•™ì‹¤ ì˜ˆì•½ ì‹œìŠ¤í…œ</h1>
            <p class="text-lg text-gray-600">ëŒ€ì „ê´€ì €ê³ ë“±í•™êµ</p>
            <div id="connectionStatus" class="mt-4 p-3 rounded-lg text-sm font-medium">
                <span id="statusText">ì—°ê²° ìƒíƒœ í™•ì¸ ì¤‘...</span>
            </div>
        </header>

        <!-- ê³¼í•™ì‹¤ ì„ íƒ -->
        <div class="max-w-4xl mx-auto mb-8">
            <div class="text-center mb-6">
                <label for="labSelect" class="block text-lg font-semibold text-gray-700 mb-3">ê³¼í•™ì‹¤ ì„ íƒ</label>
                <select id="labSelect" class="px-6 py-3 text-lg font-semibold rounded-lg border-2 border-gray-300 bg-white hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                    <option value="chemistry">ğŸ§ª í™”í•™ì‹¤ (1ì¸µ)</option>
                    <option value="physics">âš¡ ë¬¼ë¦¬ì‹¤ (3ì¸µ)</option>
                </select>
            </div>
            
            <!-- ì„ íƒëœ ê³¼í•™ì‹¤ í‘œì‹œ -->
            <div class="text-center">
                <div id="selectedLabDisplay" class="text-xl font-bold text-chemistry-600 bg-chemistry-50 px-6 py-3 rounded-lg border-2 border-chemistry-200 inline-block">
                    ğŸ§ª í™”í•™ì‹¤ (1ì¸µ)ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤
                </div>
            </div>
        </div>

        <!-- ì£¼ê°„ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="max-w-4xl mx-auto mb-6">
            <div class="flex justify-between items-center bg-white rounded-lg shadow-md p-4">
                <button id="prevWeekBtn" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">
                    â† ì´ì „ ì£¼
                </button>
                <div class="text-center">
                    <div id="weekRange" class="text-lg font-semibold text-gray-900"></div>
                    <div id="weekStatus" class="text-sm text-gray-600"></div>
                </div>
                <button id="nextWeekBtn" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">
                    ë‹¤ìŒ ì£¼ â†’
                </button>
            </div>
        </div>

        <!-- ì‹œê°„í‘œ -->
        <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-md overflow-hidden">
            <!-- ìš”ì¼ í—¤ë” -->
            <div class="grid grid-cols-6 bg-gray-100">
                <div class="p-4 font-semibold text-gray-700 border-r border-gray-200"></div>
                <div class="p-4 font-semibold text-gray-700 border-r border-gray-200 text-center">ì›”</div>
                <div class="p-4 font-semibold text-gray-700 border-r border-gray-200 text-center">í™”</div>
                <div class="p-4 font-semibold text-gray-700 border-r border-gray-200 text-center">ìˆ˜</div>
                <div class="p-4 font-semibold text-gray-700 border-r border-gray-200 text-center">ëª©</div>
                <div class="p-4 font-semibold text-gray-700 border-r border-gray-200 text-center">ê¸ˆ</div>
            </div>

            <!-- ë‚ ì§œ í—¤ë” -->
            <div class="grid grid-cols-6 bg-gray-50">
                <div class="p-2 font-semibold text-gray-700 border-r border-gray-200"></div>
                <div id="date-0" class="p-2 text-sm text-gray-600 border-r border-gray-200 text-center"></div>
                <div id="date-1" class="p-2 text-sm text-gray-600 border-r border-gray-200 text-center"></div>
                <div id="date-2" class="p-2 text-sm text-gray-600 border-r border-gray-200 text-center"></div>
                <div id="date-3" class="p-2 text-sm text-gray-600 border-r border-gray-200 text-center"></div>
                <div id="date-4" class="p-2 text-sm text-gray-600 border-r border-gray-200 text-center"></div>
            </div>

            <!-- êµì‹œë³„ í–‰ -->
            <div id="timetableBody">
                <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
            </div>
        </div>

        <!-- ë²”ë¡€ -->
        <div class="max-w-4xl mx-auto mt-8 bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">ë²”ë¡€</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-white border border-gray-300 rounded mr-2"></div>
                    <span class="text-sm text-gray-600">ì˜ˆì•½ ê°€ëŠ¥</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-chemistry-200 border border-chemistry-400 rounded mr-2"></div>
                    <span class="text-sm text-gray-600">ğŸ§ª í™”í•™ì‹¤ ì˜ˆì•½ë¨</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-physics-200 border border-physics-400 rounded mr-2"></div>
                    <span class="text-sm text-gray-600">âš¡ ë¬¼ë¦¬ì‹¤ ì˜ˆì•½ë¨</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentLab = 'chemistry';
        let currentWeekOffset = 0;

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            checkBookingCompletion();
            initializeApp();
            // ì—°ê²° ìƒíƒœ í™•ì¸
            checkConnectionStatus();
            // ì˜¤í”„ë¼ì¸ ë°ì´í„° ë™ê¸°í™” ì‹œë„
            syncOfflineData();
        });

        function initializeApp() {
            // ì €ì¥ëœ ê³¼í•™ì‹¤ ì„ íƒ ë³µì›
            const savedLab = localStorage.getItem('selectedLab');
            if (savedLab) {
                currentLab = savedLab;
            }
            
            setupEventListeners();
            updateLabDisplay();
            updateWeekDisplay();
            updateTimetable();
        }

        function setupEventListeners() {
            // ê³¼í•™ì‹¤ ì„ íƒ
            document.getElementById('labSelect').addEventListener('change', function() {
                currentLab = this.value;
                // ì„ íƒëœ ê³¼í•™ì‹¤ì„ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
                localStorage.setItem('selectedLab', currentLab);
                updateLabDisplay();
                updateTimetable();
            });

            // ì£¼ê°„ ë„¤ë¹„ê²Œì´ì…˜
            document.getElementById('prevWeekBtn').addEventListener('click', function() {
                currentWeekOffset--;
                updateWeekDisplay();
                updateTimetable();
            });

            document.getElementById('nextWeekBtn').addEventListener('click', function() {
                currentWeekOffset++;
                updateWeekDisplay();
                updateTimetable();
            });
        }

        function updateLabDisplay() {
            const labSelect = document.getElementById('labSelect');
            const selectedLabDisplay = document.getElementById('selectedLabDisplay');
            
            labSelect.value = currentLab;
            
            if (currentLab === 'chemistry') {
                selectedLabDisplay.className = 'text-xl font-bold text-chemistry-600 bg-chemistry-50 px-6 py-3 rounded-lg border-2 border-chemistry-200 inline-block';
                selectedLabDisplay.innerHTML = 'ğŸ§ª í™”í•™ì‹¤ (1ì¸µ)ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤';
            } else {
                selectedLabDisplay.className = 'text-xl font-bold text-physics-600 bg-physics-50 px-6 py-3 rounded-lg border-2 border-physics-200 inline-block';
                selectedLabDisplay.innerHTML = 'âš¡ ë¬¼ë¦¬ì‹¤ (3ì¸µ)ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤';
            }
        }

        function getCurrentWeekDates() {
            const today = new Date();
            const monday = new Date(today);
            monday.setDate(today.getDate() - today.getDay() + 1 + (currentWeekOffset * 7));
            
            const weekDates = [];
            for (let i = 0; i < 5; i++) {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                weekDates.push(date);
            }
            return weekDates;
        }

        function formatDate(date) {
            return `${date.getMonth() + 1}/${date.getDate()}`;
        }

        function updateWeekDisplay() {
            const weekDates = getCurrentWeekDates();
            const weekRange = document.getElementById('weekRange');
            const weekStatus = document.getElementById('weekStatus');
            
            weekRange.textContent = `${formatDate(weekDates[0])} - ${formatDate(weekDates[4])}`;
            
            if (currentWeekOffset === 0) {
                weekStatus.textContent = 'ì´ë²ˆ ì£¼';
            } else if (currentWeekOffset > 0) {
                weekStatus.textContent = `${currentWeekOffset}ì£¼ í›„`;
            } else {
                weekStatus.textContent = `${Math.abs(currentWeekOffset)}ì£¼ ì „`;
            }

            // ë‚ ì§œ í—¤ë” ì—…ë°ì´íŠ¸
            weekDates.forEach((date, index) => {
                document.getElementById(`date-${index}`).textContent = formatDate(date);
            });
        }

        async function updateTimetable() {
            const timetableBody = document.getElementById('timetableBody');
            const weekDates = getCurrentWeekDates();
            const reservations = await getReservations();
            const currentLabName = currentLab === 'chemistry' ? 'í™”í•™ì‹¤' : 'ë¬¼ë¦¬ì‹¤';
            
            let html = '';
            
            // 1êµì‹œë¶€í„° 7êµì‹œê¹Œì§€
            for (let period = 1; period <= 7; period++) {
                html += `<div class="grid grid-cols-6 border-b border-gray-200">`;
                html += `<div class="p-4 font-semibold text-gray-700 bg-gray-50 border-r border-gray-200 flex items-center justify-center">${period}êµì‹œ</div>`;
                
                // ì›”ìš”ì¼ë¶€í„° ê¸ˆìš”ì¼ê¹Œì§€
                for (let dayIndex = 0; dayIndex < 5; dayIndex++) {
                    const date = weekDates[dayIndex];
                    const dateString = date.toISOString().split('T')[0];
                    
                    // í˜„ì¬ ì£¼ì˜ í˜„ì¬ ê³¼í•™ì‹¤ ì˜ˆì•½ í™•ì¸
                    const reservation = reservations.find(r => 
                        r.lab === currentLabName && 
                        r.date === dateString && 
                        r.period === period
                    );
                    
                    if (reservation) {
                        // ì˜ˆì•½ëœ ì…€
                        const labColor = reservation.lab === 'í™”í•™ì‹¤' ? 'chemistry' : 'physics';
                        const labIcon = reservation.lab === 'í™”í•™ì‹¤' ? 'ğŸ§ª' : 'âš¡';
                        
                        html += `
                            <div class="p-2 border-r border-gray-200 bg-${labColor}-200 border-${labColor}-400">
                                <div class="text-center text-${labColor}-800">
                                    <div class="text-xs font-bold">${labIcon} ì˜ˆì•½ë¨</div>
                                    <div class="text-xs mt-1 font-semibold">${reservation.teacherName}</div>
                                    <div class="text-xs">${reservation.className}</div>
                                    <button type="button" 
                                            class="delete-reservation-btn mt-1 bg-red-500 hover:bg-red-600 text-white text-xs px-2 py-1 rounded transition-colors cursor-pointer"
                                            data-lab="${reservation.lab}" 
                                            data-date="${reservation.date}" 
                                            data-period="${reservation.period}">
                                        ğŸ—‘ï¸
                                    </button>
                                </div>
                            </div>
                        `;
                    } else {
                        // ì˜ˆì•½ ê°€ëŠ¥í•œ ì…€
                        html += `
                            <div class="p-2 border-r border-gray-200 bg-white hover:bg-gray-50 cursor-pointer"
                                 onclick="openBookingForm(${dayIndex}, ${period})">
                                <div class="text-center text-gray-400">
                                    <div class="text-sm">ì˜ˆì•½ ê°€ëŠ¥</div>
                                    <div class="text-xs mt-1">í´ë¦­í•˜ì—¬ ì˜ˆì•½</div>
                                </div>
                            </div>
                        `;
                    }
                }
                html += `</div>`;
            }
            
            timetableBody.innerHTML = html;
            
            // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            document.querySelectorAll('.delete-reservation-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    
                    const labName = this.getAttribute('data-lab');
                    const date = this.getAttribute('data-date');
                    const period = parseInt(this.getAttribute('data-period'));
                    
                    deleteReservation(labName, date, period);
                });
            });
        }

        function openBookingForm(dayIndex, period) {
            const weekDates = getCurrentWeekDates();
            const selectedDate = weekDates[dayIndex];
            const labName = currentLab === 'chemistry' ? 'í™”í•™ì‹¤' : 'ë¬¼ë¦¬ì‹¤';
            const dateString = selectedDate.toISOString().split('T')[0];
            
            const confirmMessage = `${labName} ${selectedDate.toLocaleDateString('ko-KR')} ${period}êµì‹œ ì˜ˆì•½ì„ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
            
            if (confirm(confirmMessage)) {
                const bookingUrl = `booking.html?lab=${labName}&date=${dateString}&period=${period}`;
                const newWindow = window.open(bookingUrl, '_blank', 'width=600,height=800,scrollbars=yes,resizable=yes');
                
                if (!newWindow) {
                    if (confirm('íŒì—… ì°½ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.\nê°™ì€ ì°½ì—ì„œ ì˜ˆì•½ í˜ì´ì§€ë¥¼ ì—´ê¹Œìš”?')) {
                        window.location.href = bookingUrl;
                    }
                }
            }
        }

        async function deleteReservation(labName, date, period) {
            const confirmMessage = `ì •ë§ë¡œ ì´ ì˜ˆì•½ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nê³¼í•™ì‹¤: ${labName}\në‚ ì§œ: ${new Date(date).toLocaleDateString('ko-KR')}\nêµì‹œ: ${period}êµì‹œ`;
            
            if (confirm(confirmMessage)) {
                try {
                    // ì„œë²„ì—ì„œ ì‚­ì œ
                    const response = await fetch(`/api/reservations?lab=${encodeURIComponent(labName)}&date=${encodeURIComponent(date)}&period=${period}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        // ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë¨
                        await updateTimetable();
                    } else {
                        const errorData = await response.json();
                        alert(`ì‚­ì œ ì‹¤íŒ¨: ${errorData.error}`);
                    }
                } catch (error) {
                    console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
                    // ì˜¤í”„ë¼ì¸ ëª¨ë“œ: ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì‚­ì œ
                    const reservations = JSON.parse(localStorage.getItem('reservations') || '[]');
                    const updatedReservations = reservations.filter(reservation => {
                        return !(reservation.lab === labName && 
                                 reservation.date === date && 
                                 reservation.period === period);
                    });
                    
                    localStorage.setItem('reservations', JSON.stringify(updatedReservations));
                    await updateTimetable();
                }
            }
        }

        // ì„œë²„ì—ì„œ ì˜ˆì•½ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function getReservations() {
            try {
                console.log('ì„œë²„ì—ì„œ ì˜ˆì•½ ë°ì´í„° ìš”ì²­ ì¤‘...');
                const response = await fetch('/api/reservations');
                console.log('ì„œë²„ ì‘ë‹µ ìƒíƒœ:', response.status);
                
                if (!response.ok) {
                    throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('ì„œë²„ì—ì„œ ë°›ì€ ì˜ˆì•½ ë°ì´í„°:', data);
                return data;
            } catch (error) {
                console.error('ì„œë²„ ì—°ê²° ì‹¤íŒ¨:', error);
                console.log('ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ ì „í™˜ - ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë°ì´í„° ë¡œë“œ');
                // ì˜¤í”„ë¼ì¸ ëª¨ë“œ: ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ê°€ì ¸ì˜¤ê¸°
                const localData = JSON.parse(localStorage.getItem('reservations') || '[]');
                console.log('ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë°ì´í„°:', localData);
                return localData;
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì˜ˆì•½ ì™„ë£Œ í™•ì¸ (ì•Œë¦¼ ì—†ì´)
        function checkBookingCompletion() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('bookingCompleted') === 'true') {
                // URLì—ì„œ ì „ë‹¬ëœ ê³¼í•™ì‹¤ ì •ë³´ê°€ ìˆìœ¼ë©´ í•´ë‹¹ ê³¼í•™ì‹¤ë¡œ ì„¤ì •
                const labParam = urlParams.get('lab');
                if (labParam && (labParam === 'chemistry' || labParam === 'physics')) {
                    currentLab = labParam;
                    localStorage.setItem('selectedLab', currentLab);
                }
                // URLì—ì„œ íŒŒë¼ë¯¸í„° ì œê±°
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // í˜ì´ì§€ í¬ì»¤ìŠ¤ ì‹œ ì—…ë°ì´íŠ¸
        window.addEventListener('focus', function() {
            updateTimetable();
        });

        // ì£¼ê¸°ì  ë°ì´í„° ë™ê¸°í™” (30ì´ˆë§ˆë‹¤)
        setInterval(async function() {
            try {
                await updateTimetable();
                console.log('ë°ì´í„° ë™ê¸°í™” ì™„ë£Œ');
            } catch (error) {
                console.error('ë°ì´í„° ë™ê¸°í™” ì˜¤ë¥˜:', error);
            }
        }, 30000);

        // ì˜¤í”„ë¼ì¸ ë°ì´í„°ë¥¼ ì„œë²„ì— ë™ê¸°í™”
        async function syncOfflineData() {
            const localReservations = JSON.parse(localStorage.getItem('reservations') || '[]');
            if (localReservations.length === 0) return;

            try {
                const serverReservations = await getReservations();
                
                // ë¡œì»¬ì—ë§Œ ìˆëŠ” ì˜ˆì•½ë“¤ì„ ì„œë²„ì— ì¶”ê°€
                for (const localReservation of localReservations) {
                    const existsOnServer = serverReservations.some(serverRes => 
                        serverRes.lab === localReservation.lab &&
                        serverRes.date === localReservation.date &&
                        serverRes.period === localReservation.period
                    );
                    
                    if (!existsOnServer) {
                        const response = await fetch('/api/reservations', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(localReservation)
                        });
                        
                        if (response.ok) {
                            console.log('ì˜¤í”„ë¼ì¸ ì˜ˆì•½ì´ ì„œë²„ì— ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤:', localReservation);
                        }
                    }
                }
                
                // ë™ê¸°í™” ì™„ë£Œ í›„ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì´ˆê¸°í™”
                localStorage.removeItem('reservations');
                console.log('ì˜¤í”„ë¼ì¸ ë°ì´í„° ë™ê¸°í™” ì™„ë£Œ');
                
            } catch (error) {
                console.error('ì˜¤í”„ë¼ì¸ ë°ì´í„° ë™ê¸°í™” ì˜¤ë¥˜:', error);
            }
        }

        // ì—°ê²° ìƒíƒœ í™•ì¸
        async function checkConnectionStatus() {
            const statusElement = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            
            try {
                console.log('ì„œë²„ ì—°ê²° ìƒíƒœ í™•ì¸ ì¤‘...');
                const response = await fetch('/api/reservations');
                
                if (response.ok) {
                    statusElement.className = 'mt-4 p-3 rounded-lg text-sm font-medium bg-green-100 text-green-800 border border-green-200';
                    statusText.textContent = 'âœ… ì„œë²„ ì—°ê²°ë¨ - ì‹¤ì‹œê°„ ë™ê¸°í™” í™œì„±í™”';
                    console.log('ì„œë²„ ì—°ê²° ì„±ê³µ');
                } else {
                    throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
                }
            } catch (error) {
                console.error('ì„œë²„ ì—°ê²° ì‹¤íŒ¨:', error);
                statusElement.className = 'mt-4 p-3 rounded-lg text-sm font-medium bg-yellow-100 text-yellow-800 border border-yellow-200';
                statusText.textContent = 'âš ï¸ ì˜¤í”„ë¼ì¸ ëª¨ë“œ - ë¡œì»¬ ì €ì¥ì†Œ ì‚¬ìš© ì¤‘';
            }
        }
    </script>
</body>
</html>