<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³¼í•™ì‹¤ ì˜ˆì•½ - ëŒ€ì „ê´€ì €ê³ ë“±í•™êµ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'chemistry': {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        },
                        'physics': {
                            50: '#faf5ff',
                            100: '#f3e8ff',
                            200: '#e9d5ff',
                            300: '#d8b4fe',
                            400: '#c084fc',
                            500: '#a855f7',
                            600: '#9333ea',
                            700: '#7c3aed',
                            800: '#6b21a8',
                            900: '#581c87',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <!-- í—¤ë” -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">ğŸ§ªâš¡ ê³¼í•™ì‹¤ ì˜ˆì•½</h1>
            <h2 class="text-2xl text-gray-700 mb-4">ëŒ€ì „ê´€ì €ê³ ë“±í•™êµ</h2>
            <button onclick="goBack()" class="text-blue-600 hover:text-blue-800 font-medium">
                â† ì‹œê°„í‘œë¡œ ëŒì•„ê°€ê¸°
            </button>
        </header>

        <!-- ì˜ˆì•½ ì •ë³´ ìš”ì•½ -->
        <div class="max-w-2xl mx-auto mb-8 bg-white rounded-lg shadow-md p-6">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">ì˜ˆì•½ ì •ë³´</h3>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <span class="text-gray-600">ê³¼í•™ì‹¤:</span>
                    <span id="labInfo" class="ml-2 font-semibold text-gray-900"></span>
                </div>
                <div>
                    <span class="text-gray-600">ë‚ ì§œ:</span>
                    <span id="dateInfo" class="ml-2 font-semibold text-gray-900"></span>
                </div>
                <div>
                    <span class="text-gray-600">êµì‹œ:</span>
                    <span id="periodInfo" class="ml-2 font-semibold text-gray-900"></span>
                </div>
            </div>
        </div>

        <!-- ì˜ˆì•½ í¼ -->
        <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-md p-6">
            <h3 class="text-xl font-semibold text-gray-900 mb-6">ì˜ˆì•½ ì •ë³´ ì…ë ¥</h3>
            
            <form id="bookingForm" class="space-y-6">
                <div>
                    <label for="teacherName" class="block text-sm font-medium text-gray-700 mb-2">
                        êµì‚¬ëª… *
                    </label>
                    <input type="text" 
                           id="teacherName" 
                           name="teacherName" 
                           required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="êµì‚¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>

                <div>
                    <label for="purpose" class="block text-sm font-medium text-gray-700 mb-2">
                        ìš©ë„ *
                    </label>
                    <input type="text" 
                           id="purpose" 
                           name="purpose" 
                           required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="ì˜ˆ: í™”í•™ì‹¤í—˜, ë¬¼ë¦¬ì‹¤í—˜, ê³¼í•™ìˆ˜ì—… ë“±">
                </div>

                <div>
                    <label for="className" class="block text-sm font-medium text-gray-700 mb-2">
                        ë°˜ *
                    </label>
                    <input type="text" 
                           id="className" 
                           name="className" 
                           required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="ì˜ˆ: 1-3ë°˜, 2-1ë°˜ ë“±">
                </div>

                <div class="flex space-x-4 pt-4">
                    <button type="button" 
                            onclick="goBack()" 
                            class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                        ì·¨ì†Œ
                    </button>
                    <button type="button" 
                            onclick="submitReservation()"
                            class="flex-1 bg-green-500 hover:bg-green-600 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                        ì˜ˆì•½í•˜ê¸°
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // URL íŒŒë¼ë¯¸í„°ì—ì„œ ì˜ˆì•½ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                lab: urlParams.get('lab'),
                date: urlParams.get('date'),
                period: urlParams.get('period')
            };
        }

        // ì˜ˆì•½ ì •ë³´ í‘œì‹œ
        function displayReservationInfo() {
            const params = getUrlParams();
            
            if (params.lab && params.date && params.period) {
                const labName = params.lab;
                const date = new Date(params.date);
                const period = params.period;
                
                document.getElementById('labInfo').textContent = labName;
                document.getElementById('dateInfo').textContent = date.toLocaleDateString('ko-KR');
                document.getElementById('periodInfo').textContent = `${period}êµì‹œ`;
            }
        }

        // ì˜ˆì•½í•˜ê¸° ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
        async function submitReservation() {
            const teacherName = document.getElementById('teacherName').value.trim();
            const purpose = document.getElementById('purpose').value.trim();
            const className = document.getElementById('className').value.trim();

            if (!teacherName || !purpose || !className) {
                return;
            }

            const params = getUrlParams();
            
            // ì¤‘ë³µ ì˜ˆì•½ í™•ì¸
            if (await checkDuplicateReservation(params.lab, params.date, params.period)) {
                alert('ì´ë¯¸ ì˜ˆì•½ëœ ì‹œê°„ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì˜ˆì•½ ì •ë³´ ìƒì„±
            const reservation = {
                lab: params.lab,
                date: params.date,
                period: parseInt(params.period),
                teacherName: teacherName,
                purpose: purpose,
                className: className,
                createdAt: new Date().toISOString()
            };

            try {
                // ì„œë²„ì— ì˜ˆì•½ ì €ì¥
                console.log('ì„œë²„ì— ì˜ˆì•½ ì €ì¥ ì¤‘:', reservation);
                const response = await fetch('/api/reservations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(reservation)
                });

                console.log('ì„œë²„ ì‘ë‹µ ìƒíƒœ:', response.status);

                if (response.ok) {
                    // ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë¨
                    const savedReservation = await response.json();
                    console.log('ì˜ˆì•½ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤:', savedReservation);
                    alert('âœ… ì˜ˆì•½ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                } else {
                    const errorData = await response.json();
                    console.error('ì„œë²„ ì˜¤ë¥˜:', errorData);
                    alert(`âŒ ì˜ˆì•½ ì‹¤íŒ¨: ${errorData.error}`);
                    return;
                }
            } catch (error) {
                console.error('ì˜ˆì•½ ì €ì¥ ì˜¤ë¥˜:', error);
                // ì˜¤í”„ë¼ì¸ ëª¨ë“œ: ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
                console.log('ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ ì˜ˆì•½ ì €ì¥');
                const reservations = JSON.parse(localStorage.getItem('reservations') || '[]');
                reservations.push(reservation);
                localStorage.setItem('reservations', JSON.stringify(reservations));
                alert('âš ï¸ ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ ì˜ˆì•½ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ì„œë²„ ì—°ê²° ì‹œ ë™ê¸°í™”ë©ë‹ˆë‹¤.');
            }

            // ë¶€ëª¨ ì°½ ìƒˆë¡œê³ ì¹¨ í›„ ì¦‰ì‹œ ì°½ ë‹«ê¸° (alert ì—†ì´)
            if (window.opener && !window.opener.closed) {
                // í˜„ì¬ ì˜ˆì•½í•œ ê³¼í•™ì‹¤ ì •ë³´ë¥¼ URLì— í¬í•¨
                const labParam = params.lab === 'í™”í•™ì‹¤' ? 'chemistry' : 'physics';
                window.opener.location.href = `index.html?bookingCompleted=true&lab=${labParam}`;
                window.close();
            } else {
                const labParam = params.lab === 'í™”í•™ì‹¤' ? 'chemistry' : 'physics';
                window.location.href = `index.html?bookingCompleted=true&lab=${labParam}`;
            }
        }

        // ì„œë²„ì—ì„œ ì¤‘ë³µ ì˜ˆì•½ í™•ì¸
        async function checkDuplicateReservation(labName, date, period) {
            try {
                console.log('ì¤‘ë³µ ì˜ˆì•½ í™•ì¸ ì¤‘:', { labName, date, period });
                const response = await fetch(`/api/reservations?lab=${encodeURIComponent(labName)}&date=${encodeURIComponent(date)}&period=${period}`);
                console.log('ì¤‘ë³µ í™•ì¸ ì‘ë‹µ ìƒíƒœ:', response.status);
                
                if (response.ok) {
                    const reservations = await response.json();
                    console.log('ì„œë²„ì—ì„œ ë°›ì€ ì˜ˆì•½ ëª©ë¡:', reservations);
                    return reservations.length > 0;
                } else {
                    console.log('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜:', response.status);
                }
            } catch (error) {
                console.error('ì¤‘ë³µ í™•ì¸ ì˜¤ë¥˜:', error);
            }
            
            // ì˜¤í”„ë¼ì¸ ëª¨ë“œ: ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ í™•ì¸
            console.log('ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ ì¤‘ë³µ í™•ì¸');
            const reservations = JSON.parse(localStorage.getItem('reservations') || '[]');
            return reservations.some(reservation => 
                reservation.lab === labName && 
                reservation.date === date && 
                reservation.period === parseInt(period)
            );
        }

        // ë’¤ë¡œ ê°€ê¸°
        function goBack() {
            if (window.opener) {
                // ë¶€ëª¨ ì°½ì´ ìˆìœ¼ë©´ ìƒˆë¡œê³ ì¹¨í•˜ê³  ë‹«ê¸°
                window.opener.location.reload();
                window.close();
            } else {
                // ë¶€ëª¨ ì°½ì´ ì—†ìœ¼ë©´ ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
                window.location.href = 'index.html';
            }
        }

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            displayReservationInfo();
        });
    </script>
</body>
</html>